<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Use elevationInfo in 3D visualization - 4.3</title>
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    #elevationDiv {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 12px;d
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
    }
    
    #queryDiv {
      position: absolute;
      bottom: 12px;
      left: 12px;
      padding: 12px;
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
    }
  </style>

  <link rel="stylesheet" href="https://js.arcgis.com/4.3/esri/css/main.css">
  <script src="https://js.arcgis.com/4.3/"></script>

  <script>
    require([
      "esri/Map",
      "esri/views/SceneView",
      "esri/layers/FeatureLayer",
      "esri/layers/GroupLayer",
      "esri/layers/MapImageLayer",
      "esri/renderers/SimpleRenderer",
      "esri/renderers/Renderer",
      "esri/symbols/PointSymbol3D",
      "esri/symbols/ObjectSymbol3DLayer",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/tasks/support/Query",
	  "esri/core/urlUtils",
      "esri/core/Collection",
      "esri/layers/GraphicsLayer", 
      "esri/Graphic",
      "esri/core/watchUtils",
        
      "dojo/on",
      "dojo/dom",
      "dojo/domReady!"
    ], function(Map, SceneView, FeatureLayer, GroupLayer, MapImageLayer, SimpleRenderer, Renderer, PointSymbol3D, ObjectSymbol3DLayer, LayerList, Legend, Query, urlUtils, GraphicsLayer, Graphic, watchUtils, Collection, on, dom) {	
      var layer_spacing = 20
    
      // Create the Map
      var map = new Map({
        basemap: "streets",
        ground: "world-elevation"
      });

      // Create the SceneView
      var view = new SceneView({
        container: "viewDiv",
        map: map,
        camera: {
          position: [-135, 58, 20914],
          heading: 20,
          tilt: 80
        }
      });
      
      function getLayerInfos() {
          var layerInfos = [];
          for (var index in map.allLayers.items) {
              var lyr = map.allLayers.items[index]
              if (lyr.title == 'World Street Map' || lyr.title == "Terrain3D") {
                  continue; // We don't want to add these layers to our legend
              }
              layerInfos.push({
                  layer: lyr,
                  title: lyr.title
              });
          }
          console.log( 'Legend:' );
          console.log( layerInfos );
          return layerInfos;
      }
      
      function createLegend() {  
          var legend = new Legend({
                view: view,
                layerInfos: getLayerInfos()  
              });

          // Add widget to the bottom left corner of the view
          view.ui.add(legend, "bottom-left");
          console.log( legend );
      }
      
      var layerList = new LayerList({
          view: view
      });
      
      // Adds widget below other elements in the top left corner of the view
      view.ui.add(layerList, {
        position: "bottom-right"
      });
      
      // Creates and returns a simple renderer which produces the end of unit markers at the specified height (h)
      function createBorderRenderer( h ) {
          var borderSymbol = new PointSymbol3D({
              symbolLayers: [new ObjectSymbol3DLayer({
                width: 10,  // diameter of the object from east to west in meters
                height: h,  // height of the object in meters
                depth: 10,  // diameter of the object from north to south in meters
                resource: { primitive: "cylinder" },
                material: { color: "grey" }
              })]
          });

          var borderRenderer = new SimpleRenderer({
            symbol: borderSymbol
          });
          
          return borderRenderer
      }
      
      // Function that fires every time any layer changes it's visibility state.
      // Function will iterate through every layer visible in the layerList, will set their offsets incrementaly, effectively maintaining a collapsed stack
      function fireOnVisibilityChange() {
          updateElevationOffset();
      }
      
      var szMapService = new MapImageLayer({
        url: "https://alaskafisheries.noaa.gov/arcgis/rest/services/ShoreZoneMapService/MapServer"
      });
      szMapService.load();
      var count = 0
      szMapService.watch("loaded", function(){
          for (var index in szMapService.allSublayers.items) {
              layer = szMapService.allSublayers.items[index];
              parent = extractFirstAncestor( layer );
              if ((parent == "Biological Attributes" || parent == "Response Attributes" || parent == "Derived ShoreZone Attributes")&&layer.sublayers == null) { // Edit this if statement to alter the prerequisite characteristics for the layers to be permitted.
                layer_url = layer.url;
                layer_title = layer.title;
                featLayer = new FeatureLayer({
                    visible: false,
                    url: layer_url,
                    title: layer_title,
                    definitionExpression: "VIDEOTAPE='SE04_06'",
                    elevationInfo: {
                        mode: "relative-to-ground",
                        offset: count * layer_spacing
                    }
                });
                count++;
                map.add( featLayer );
              }
          }
          map.layers.forEach(lyr => lyr.watch( "visible", function(){fireOnVisibilityChange()}));
          setTimeout(function(){createLegend();},2000);
      });
      
      borderRenderer = createBorderRenderer( 200 );
      
      
      // Recursive function that determines the highest ancestor of the given layer
      function extractFirstAncestor( layer ) {
          if ( layer.parent.title == szMapService.title ) {
                return layer.title;
          }
          else {
              return extractFirstAncestor( layer.parent )
          }
      }
      
      // Create FeatureLayer, set the elevation mode and add to the map
      var layerBounds = new FeatureLayer({
        title: "Unit End Marker",
        url: "https://alaskafisheries.noaa.gov/arcgis/rest/services/ShoreZoneMapService/MapServer/58",
        definitionExpression: "Start_PHY_IDENT LIKE '10/04%'",
        elevationInfo: {
          mode: "relative-to-ground",
          offset: 0
        },
        renderer: borderRenderer
      });
      map.add(layerBounds);

      // Register events to the controls
      var offsetInput = dom.byId("offsetInput");
      var queryInput = dom.byId("queryButton");
      on(offsetInput, "blur", updateElevationOffset);
      on(offsetInput, "keypress", elevationOffsetKeypress);
      
      
      function updateElevationOffset() {
        var offset;

        try {
          offset = parseFloat(offsetInput.value, 10);
        } catch (e) {
          return;
        }
        var i = 0;
        map.layers.forEach(function(layer) {
            if (layer.visible == true && layer.id != layerBounds.id) {
                layer.elevationInfo = {
                    mode: "relative-to-ground",
                    offset: i * offset
                }
                i++;
            }
        });
        layerBounds.renderer.symbol.symbolLayers.height = (i-1) * offset;
        map.remove( layerBounds );
        map.add( layerBounds );
        console.log( layerBounds );
      };

      function elevationOffsetKeypress(ev) {
        if (ev.which === 13) {
          updateElevationOffset();
        }
      }
      
      map.layers.on( "changes", function(event) {
        console.log( 'map layers change' );
      } );
      
      

      // Function which, given a layer, will return the features of that layer that are contained within the current camera extent.
      // Function returns a promise, and the resultant featureSet should be accessed with the '.then()' function
      function findFeaturesInCameraExtent( layer ) {
        console.log( 'Constructing query...' );
        var current_view_extent = view.extent; // Grab the visible extent of the map
        var query = layer.createQuery(); // Function that creates a query that respects the various attributes of the layer in question
        query.geometry = current_view_extent;
        query.spatialRelationship = "contains";
        console.log( 'Applying query to layer...' );
        return layer.queryFeatures( query ) // Apply the spatial query to the layer, and return a promise of the result
      }
 
      function mapExtent() {
          map.extent = view.extent;
      }
 
      function queryLayer() {
          findFeaturesInCameraExtent( layer0 ).then( 
              // Success
              function(featureSet) {
                 var num_feats = featureSet.features.length;
                 console.log( 'Query executed successfully.' );
                 console.log( layer0 );
                 var newLayer = new FeatureLayer({ 
                     visible: true,
                     source: featureSet,
                     geometryType: layer0.geometryType,
                     fields: layer0.fields,
                     objectIdField: layer0.objectIdField,
                     renderer: layer0.renderer
                 });
                 console.log( newLayer );
                 map.layers.add( newLayer );
                 console.log( 'Done' )
              },
              // Failure
              function(reason) {
                  console.log(reason);
              }
          )
      }
      
    });


  </script>
</head>

<body>
<div id="viewDiv"></div>
<div id="elevationDiv">
  <table>
    <tr>
      <td>Layer spacing:</td>
      <td><input id="offsetInput" type="text" size="5" value="100"></td>
    </tr>
  </table>
</div>
</body>
</html>